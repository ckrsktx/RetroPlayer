<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#008080">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Retro Player</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='100%25' height='100%25' fill='%23008080'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='white'%3E‚ô™%3C/text%3E%3C/svg%3E">
<style>
:root{
  --bg:#c0c0c0;
  --panel:#111;
  --accent:#0f0;
  --muted:#777;
  --primary:#000080;
}
html,body{height:100%;margin:0;background:var(--bg);font-family:"MS Sans Serif","Microsoft Sans Serif",Tahoma,Arial,sans-serif;-webkit-font-smoothing:auto;}
.app{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  box-sizing:border-box;
}
.shell{
  width:360px;
  background:#e9e9e9;
  border:2px solid #000;
  box-shadow: 4px 4px 0 #808080;
  display:flex;
  flex-direction:column;
  max-height:96vh;
}
.header{
  background:var(--primary);
  color:#fff;
  padding:6px 8px;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  font-size:14px;
}
.display{
  display:flex;
  gap:8px;
  align-items:center;
  background:#000;
  color:var(--accent);
  padding:8px;
  font-family:monospace;
  min-height:64px;
}
.display .cover{
  width:48px;height:48px;border:1px solid #333;background:#111 center/cover no-repeat;flex-shrink:0;border-radius:3px;
}
.display .meta{overflow:hidden;display:flex;flex-direction:column;gap:2px;}
.display .meta .title {
  font-size:16px;
  font-weight:bold;
  color:#fff;
  overflow-wrap: break-word;
  white-space: normal;
  word-break: break-word;
  max-height: 36px;
}
.display .meta .artist{font-size:13px;font-style:italic;color:#9ae;}
.display .meta .year{font-size:11px;color:var(--muted)}
.controls{display:flex;justify-content:space-around;padding:8px;background:#ddd;border-top:2px solid #808080;}
.controls button{background:#e0e0e0;border:1px solid #000;padding:6px 10px;border-radius:3px;cursor:pointer;font-weight:bold;font-family:inherit;}
.controls button:active{background:#cfcfcf}
.progress-wrap{height:8px;background:#b7b7b7;border-top:1px solid #999;cursor:pointer}
.progress-fill{height:100%;width:0%;background:var(--primary);transition:width 0.08s linear}
.status{padding:6px;background:#eaeaea;border-top:1px solid #999;font-size:13px;text-align:center;}
.artist-area{display:flex;align-items:center;justify-content:space-between;padding:6px;gap:6px;background:#f2f2f2;border-top:1px solid #ddd;}
.artist-area .left{font-size:13px;color:#222}
select {
  font-family: "MS Sans Serif", "Microsoft Sans Serif", Tahoma, Arial, sans-serif;
  font-size: 14px;
  padding: 4px 8px;
  height: 28px;
  width: 160px;
  box-sizing: border-box;
  background-color: #f2f2f2;
  color: #000;
  border: 1px solid #333;
  border-radius: 2px;
  padding-right: 34px;
  background-image:
    linear-gradient(45deg, transparent 50%, #000 50%),
    linear-gradient(135deg, #000 50%, transparent 50%);
  background-position: calc(100% - 18px) calc(50% - 6px), calc(100% - 12px) calc(50% - 6px);
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}
.playlist-wrap{position:relative}
.playlist{
  list-style:none;
  margin:0;
  padding:0;
  background:#111;
  color:#fff;
  height:220px;
  overflow:auto;
}
.playlist li{
  height:48px;
  display:flex;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid #222;
  box-sizing:border-box;
  cursor:pointer;
}
.playlist li:hover{background:#222}
.playlist li.active{background:#003366}
.track-title{font-size:15px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:8px;}
.track-artist{font-size:12px;font-style:italic;color:#aaa}
.footer {
  background: #ddd;
  border-top: 2px solid #808080;
  padding: 8px;
  text-align: center;
  font-size: 12px;
  color: #555;
}
@media (max-width:720px){
  .app {
    padding: 0;
    align-items: stretch;
  }
  .shell{
    width:100vw;
    height:100vh;
    border-radius:0;
    max-height:100vh;
    border: none;
    box-shadow: none;
  }
  .playlist{
    height:calc(100vh - 64px - 48px - 8px - 48px - 80px);
    flex-grow: 1;
  }
  .display .cover{
    width:44px;
    height:44px;
  }
  .header {
    flex-wrap: wrap;
  }
  select {
    width: 140px;
    font-size: 12px;
  }
}
.header .autor {
  font-size: 12px;
  opacity: 0.7;
  margin-top: 2px;
}
</style>
</head>
<body>
<div class="app">
  <div class="shell" role="application" aria-label="Retro Player">
    <div class="header">
      <div>
        Retro Player
        <div class="autor">por M√°rcio Rocha</div>
      </div>
      <div>
        <select id="playlistSelect" title="Escolha a playlist">
          <option value="https://raw.githubusercontent.com/ckrsktx/PlayerX/refs/heads/main/AlternativeNow.json">Alternative</option>
          <option value="https://raw.githubusercontent.com/ckrsktx/PlayerX/refs/heads/main/1990s.json">1990s</option>
        </select>
      </div>
    </div>

    <div class="display" aria-live="polite">
      <div class="cover" id="cover" aria-hidden="true"></div>
      <div class="meta">
        <div class="title" id="title">Carregando...</div>
        <div class="artist" id="artist"></div>
        <div class="year" id="year"></div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Controles">
      <button id="prev" title="Anterior">‚èÆ</button>
      <button id="play" title="Play/Pause">‚ñ∂</button>
      <button id="next" title="Pr√≥ximo">‚è≠</button>
      <button id="shuffle" title="Shuffle">üîÄ</button>
    </div>

    <div class="progress-wrap" id="progressWrap" aria-hidden="false">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="status" id="status">Pronto</div>

    <div class="artist-area">
      <div class="left">Filtrar por artista</div>
      <div style="display:flex;gap:6px;align-items:center">
        <select id="artistSelect" title="Filtrar artista"><option value="__all__">Todos</option></select>
        <button id="artistClear" title="Limpar filtro" style="padding:4px 8px;font-family:inherit">Limpar</button>
      </div>
    </div>

    <div class="playlist-wrap">
      <ul class="playlist" id="playlist" role="listbox" aria-label="Playlist"></ul>
    </div>
    
    <div class="footer">
      Retro Player ¬© 2023 - Todos os direitos reservados
    </div>
  </div>
</div>

<script>
/* ----------  Retro Player  ---------- */
const playlistSelect = document.getElementById('playlistSelect');
const playlistEl = document.getElementById('playlist');
const titleEl = document.getElementById('title');
const artistEl = document.getElementById('artist');
const yearEl = document.getElementById('year');
const coverEl = document.getElementById('cover');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const shuffleBtn = document.getElementById('shuffle');
const statusEl = document.getElementById('status');
const progressFill = document.getElementById('progressFill');
const progressWrap = document.getElementById('progressWrap');
const artistSelect = document.getElementById('artistSelect');
const artistClear = document.getElementById('artistClear');

let playlistUrl = localStorage.getItem('selectedPlaylistUrl') || playlistSelect.value;
let playlistData = [], filteredData = [], current = 0;
let audio = new Audio();
let playing = false, shuffle = false;
let wakeLock = null;
let currentCoverUrl = 'https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png'; // URL padr√£o

// Solicitar bloqueio de tela para evitar que a tela desligue
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock ativado');
    }
  } catch (err) {
    console.error('Erro ao ativar Wake Lock:', err);
  }
}

// Liberar bloqueio de tela
function releaseWakeLock() {
  if (wakeLock !== null) {
    wakeLock.release();
    wakeLock = null;
    console.log('Wake Lock liberado');
  }
}

const setStatus = (t, ms=2000) => { 
  statusEl.textContent = t; 
  if(ms) setTimeout(()=>{ 
    if(statusEl.textContent === t) statusEl.textContent='Pronto'; 
  }, ms); 
};

const safeKey = (a,b) => `rp_${(a||'').replace(/\s+/g,'_')}_${(b||'').replace(/\s+/g,'_')}`;

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(reg=>{
    console.log('SW registrado', reg);
  }).catch(err=>console.warn('SW falha',err));
}

playlistSelect.addEventListener('change', async (e)=>{
  const v = e.target.value;
  playlistUrl = v;
  localStorage.setItem('selectedPlaylistUrl', playlistUrl);
  await loadPlaylist(playlistUrl);
});

async function loadPlaylist(url){
  setStatus('Carregando playlist...');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    if(!Array.isArray(json)) throw new Error('Formato inv√°lido (esperado array)');
    playlistData = json.map(t=>({
      title: String(t.title||'Untitled'),
      artist: String(t.artist||'Unknown'),
      url: String(t.url||'')
    }));
    playlistData.sort((a,b)=> a.title.localeCompare(b.title));
    filteredData = playlistData.slice();
    populateArtistFilter();
    renderPlaylist();
    current = 0;
    loadTrack(current);
    playing = false;
    playBtn.textContent = '‚ñ∂';
    highlightCurrent();
    setStatus('Playlist carregada');
  }catch(err){
    console.error(err);
    setStatus('Erro ao carregar playlist', 4000);
    alert('Erro ao carregar playlist: ' + (err.message||err));
  }
}

function populateArtistFilter(){
  const artists = Array.from(new Set(playlistData.map(p=>p.artist))).sort();
  artistSelect.innerHTML = '<option value="__all__">Todos</option>';
  artists.forEach(a=>{
    const opt=document.createElement('option'); opt.value=a; opt.textContent=a;
    artistSelect.appendChild(opt);
  });
}

artistSelect.addEventListener('change', ()=>{
  const artist = artistSelect.value;
  if(artist === '__all__'){
    filteredData = playlistData.slice();
  } else {
    filteredData = playlistData.filter(t => t.artist === artist);
  }
  renderPlaylist();
  current = 0;
  loadTrack(current);
  playing = false;
  playBtn.textContent = '‚ñ∂';
  highlightCurrent();
});

artistClear.addEventListener('click', ()=>{
  if(playlistData.length===0) return;
  const currentTrack = filteredData[current];
  artistSelect.value = '__all__';
  filteredData = playlistData.slice();
  renderPlaylist();
  const idx = filteredData.findIndex(t => t.title === currentTrack.title && t.artist === currentTrack.artist);
  if(idx !== -1) current = idx;
  loadTrack(current);
  play();
});

function renderPlaylist(){
  const frag = document.createDocumentFragment();
  filteredData.forEach((t,i)=>{
    const li = document.createElement('li');
    li.setAttribute('role','option');
    li.dataset.index = i;
    li.innerHTML = `<div style="display:flex;flex-direction:column"><span class="track-title">${escapeHtml(t.title)}</span><span class="track-artist">${escapeHtml(t.artist)}</span></div>`;
    frag.appendChild(li);
  });
  playlistEl.innerHTML = '';
  playlistEl.appendChild(frag);
  highlightCurrent();
}

playlistEl.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  const idx = Number(li.dataset.index);
  if(Number.isFinite(idx)) { loadTrack(idx); play(); }
});

async function loadTrack(idx){
  if(idx < 0 || idx >= filteredData.length) return;
  current = idx;
  const track = filteredData[current];
  audio.src = track.url;
  titleEl.textContent = track.title;
  artistEl.textContent = track.artist;
  yearEl.textContent = '';
  highlightCurrent();
  
  // Atualizar MediaSession imediatamente com informa√ß√µes b√°sicas
  setMediaSession(track);
  
  // Buscar capa e depois atualizar MediaSession novamente
  await fetchCover(track.title, track.artist);
  
  document.title = `${track.title} - ${track.artist}`;
}

function highlightCurrent(){
  const children = playlistEl.children;
  for(let i=0;i<children.length;i++){
    children[i].classList.toggle('active', Number(children[i].dataset.index) === current);
  }
  const active = playlistEl.querySelector('li.active');
  if(active) active.scrollIntoView({behavior:'smooth',block:'center'});
}

function play(){ 
  audio.play().catch(()=>{}); 
  playing=true; 
  playBtn.textContent='‚è∏'; 
  setStatus('Tocando');
  requestWakeLock(); // Ativar wake lock ao tocar
}
function pause(){ 
  audio.pause(); 
  playing=false; 
  playBtn.textContent='‚ñ∂'; 
  setStatus('Pausado');
  releaseWakeLock(); // Liberar wake lock ao pausar
}

playBtn.addEventListener('click', ()=> playing ? pause() : play());
prevBtn.addEventListener('click', ()=> {
  if(filteredData.length===0) return;
  current = (current - 1 + filteredData.length) % filteredData.length;
  loadTrack(current);
  play();
});
nextBtn.addEventListener('click', ()=> {
  if(filteredData.length===0) return;
  if(shuffle) current = Math.floor(Math.random() * filteredData.length);
  else current = (current + 1) % filteredData.length;
  loadTrack(current);
  play();
});
shuffleBtn.addEventListener('click', ()=> { 
  shuffle = !shuffle; 
  shuffleBtn.style.background = shuffle ? '#cfe' : ''; 
  setStatus('Shuffle ' + (shuffle ? 'ON' : 'OFF')); 
});

progressWrap.addEventListener('click', (e) => {
  if(!audio.duration) return;
  const rect = progressWrap.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.currentTime = pct * audio.duration;
});
audio.addEventListener('timeupdate', () => {
  const pct = (audio.currentTime / (audio.duration || 1)) * 100;
  progressFill.style.width = pct + '%';
});
audio.addEventListener('ended', () => {
  if(filteredData.length===0) return;
  if(shuffle) current = Math.floor(Math.random() * filteredData.length);
  else current = (current + 1) % filteredData.length;
  loadTrack(current);
  play();
});

/* MediaSession com capa - CORRIGIDO */
function setMediaSession(track, coverUrl = null) {
  if ("mediaSession" in navigator) {
    // Usar a URL fornecida ou a atual
    const artworkUrl = coverUrl || currentCoverUrl;
    
    navigator.mediaSession.metadata = new MediaMetadata({
      title: track.title,
      artist: track.artist,
      album: "Minha Playlist",
      artwork: [
        { src: artworkUrl, sizes: "512x512", type: "image/png" }
      ]
    });

    navigator.mediaSession.setActionHandler('play', ()=> play());
    navigator.mediaSession.setActionHandler('pause', ()=> pause());
    navigator.mediaSession.setActionHandler('previoustrack', ()=> prevBtn.click());
    navigator.mediaSession.setActionHandler('nexttrack', ()=> nextBtn.click());
  }
}

/* Last.fm cover fetch - ATUALIZADO */
async function fetchCover(title, artist){
  const key = safeKey('cover', artist + '_' + title);
  const cached = localStorage.getItem(key);
  
  if(cached){ 
    coverEl.style.backgroundImage = `url(${cached})`;
    currentCoverUrl = cached; // Atualizar a URL atual
    setMediaSession(filteredData[current], cached); // Atualizar MediaSession com a capa correta
    return; 
  }
  
  try{
    const apiKey = '685a04193652e98c9e5e598dc6d306ab';
    const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${apiKey}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(title)}&format=json`);
    const data = await res.json();
    const url = data?.track?.album?.image?.slice(-1)[0]?.['#text'] || 'https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png';
    
    coverEl.style.backgroundImage = `url(${url})`;
    currentCoverUrl = url; // Atualizar a URL atual
    
    // Atualizar MediaSession com a nova capa
    setMediaSession(filteredData[current], url);
    
    yearEl.textContent = data?.track?.wiki?.published ? new Date(data.track.wiki.published).getFullYear() : '';
    localStorage.setItem(key, url);
  }catch(e){
    console.error('Erro ao buscar capa:', e);
    coverEl.style.backgroundImage = `url(https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png)`;
    currentCoverUrl = 'https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png';
    setMediaSession(filteredData[current], currentCoverUrl);
    yearEl.textContent = '';
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Gerenciar wake lock quando a p√°gina perde/ganha visibilidade
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    releaseWakeLock();
  } else if (playing) {
    requestWakeLock();
  }
});

(async function init(){
  const saved = localStorage.getItem('selectedPlaylistUrl');
  if(saved){ 
    playlistUrl = saved;
    if(![...playlistSelect.options].some(o=>o.value===playlistUrl)){
      const opt=document.createElement('option'); 
      opt.value=playlistUrl; 
      opt.textContent='Playlist selecionada'; 
      playlistSelect.add(opt, playlistSelect.options[playlistSelect.options.length-1]);
    }
    playlistSelect.value = playlistUrl;
  }
  await loadPlaylist(playlistUrl);
})();
</script>
</body>
</html>
