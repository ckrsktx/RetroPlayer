<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>Retro Player</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;background:#008080;font-family:"Microsoft Sans Serif",Tahoma,Arial,sans-serif;overflow:hidden}
  .app{display:flex;flex-direction:column;height:100vh;width:100vw}
  .shell{flex:1;display:flex;flex-direction:column;padding:6px;box-sizing:border-box;background:#c0c0c0;border:2px outset #fff}
  .header{background:#000080;color:#fff;padding:6px;font-weight:bold;font-size:16px;display:flex;justify-content:space-between;align-items:center}
  .header small{font-weight:normal;font-size:11px;display:block}
  .playlist{flex:1;overflow-y:auto;background:#fff;border:1px inset #000;margin-top:6px;padding:4px}
  .playlist div{padding:4px;cursor:pointer;border-bottom:1px solid #ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .playlist div.active{background:#000080;color:#fff}
  .artist-area{margin:8px 0;display:flex;justify-content:center}
  .artist-area select{padding:4px;width:95%;max-width:300px;font-family:inherit}
  .controls{display:flex;justify-content:center;gap:6px;margin:6px 0}
  button{padding:4px 8px;border:2px outset #fff;background:#e0e0e0;cursor:pointer}
  button:active{border:2px inset #000}
  .status{background:#000;color:#0f0;font-size:13px;padding:4px;text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .coverbar{display:flex;align-items:center;background:#222;color:#fff;padding:4px;gap:8px}
  .coverbar .cover{width:40px;height:40px;background:#444 center/cover no-repeat;flex-shrink:0}
  .coverbar .info{flex:1;overflow:hidden}
  .coverbar .title{font-size:14px;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .coverbar .artist{font-size:12px;font-style:italic;color:#ccc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .coverbar .year{font-size:11px;color:#aaa}
  canvas{width:100%;height:160px;display:block;background:#000}
</style>
</head>
<body>
<div class="app">
  <div class="shell" role="application" aria-label="Retro Player">
    <div class="header">
      <div>Retro Player<small>por M√°rcio Rocha</small></div>
      <div>
        <select id="playlistSelect" title="Escolha a playlist" style="padding:4px;font-family:inherit">
          <option value="https://raw.githubusercontent.com/ckrsktx/PlayerX/refs/heads/main/AlternativeNow.json">Alternative Now</option>
          <option value="https://raw.githubusercontent.com/ckrsktx/PlayerX/refs/heads/main/1990s.json">1990s</option>
        </select>
      </div>
    </div>

    <div class="coverbar">
      <div class="cover" id="cover"></div>
      <div class="info">
        <div class="title" id="trackTitle">‚Äî</div>
        <div class="artist" id="trackArtist">‚Äî</div>
        <div class="year" id="trackYear"></div>
      </div>
    </div>

    <div class="controls">
      <button id="prevBtn">‚èÆ</button>
      <button id="playBtn">‚ñ∂</button>
      <button id="nextBtn">‚è≠</button>
      <button id="shuffleBtn">üîÄ</button>
    </div>

    <div class="status" id="status">Carregando...</div>

    <div class="playlist" id="playlist"></div>

    <div class="artist-area">
      <select id="artistSelect"><option value="">Todos os artistas</option></select>
    </div>

    <canvas id="visualizer"></canvas>

    <audio id="audio" crossorigin="anonymous"></audio>
  </div>
</div>

<script>
let audio = document.getElementById('audio');
let playBtn=document.getElementById('playBtn'),prevBtn=document.getElementById('prevBtn'),nextBtn=document.getElementById('nextBtn'),shuffleBtn=document.getElementById('shuffleBtn');
let playlistEl=document.getElementById('playlist'),playlistSelect=document.getElementById('playlistSelect'),artistSelect=document.getElementById('artistSelect');
let coverEl=document.getElementById('cover'),titleEl=document.getElementById('trackTitle'),artistEl=document.getElementById('trackArtist'),yearEl=document.getElementById('trackYear'),statusEl=document.getElementById('status');

let playlistData=[],current=0,shuffling=false;
let audioCtx,analyser,sourceNode,rafId,initialized=false;

function setStatus(t){statusEl.textContent=t;}

async function loadPlaylist(url){
  setStatus('Carregando...');
  try{
    let res=await fetch(url);if(!res.ok) throw new Error(res.status);
    let json=await res.json();if(!Array.isArray(json)) throw new Error("Formato inv√°lido");
    playlistData=json.map(t=>({title:String(t.title||"Untitled"),artist:String(t.artist||"Unknown"),url:String(t.url||"")}));
    playlistData.sort((a,b)=>a.title.localeCompare(b.title));
    renderPlaylist();
    fillArtistMenu();
    current=0;
    loadTrack(current,true);
  }catch(e){setStatus("Erro: "+e.message);}
}

function renderPlaylist(list=playlistData){
  playlistEl.innerHTML="";
  list.forEach((t,i)=>{
    let d=document.createElement('div');
    d.textContent=`${t.title} ‚Äî ${t.artist}`;
    d.onclick=()=>{current=i;loadTrack(current,true);play();};
    playlistEl.appendChild(d);
  });
}

function fillArtistMenu(){
  let artists=[...new Set(playlistData.map(t=>t.artist))].sort();
  artistSelect.innerHTML="<option value=''>Todos os artistas</option>"+artists.map(a=>`<option value="${a}">${a}</option>`).join("");
}

artistSelect.onchange=()=>{
  if(!artistSelect.value){renderPlaylist();loadTrack(current,false);play();}
  else{
    let filtered=playlistData.filter(t=>t.artist===artistSelect.value);
    renderPlaylist(filtered);
    current=0;
    loadTrack(current,true,filtered);
    play();
  }
};

function loadTrack(i,autoplay=false,list=playlistData){
  if(i<0||i>=list.length)return;
  current=i;
  audio.src=list[i].url;
  titleEl.textContent=list[i].title;
  artistEl.textContent=list[i].artist;
  yearEl.textContent="";
  fetchCover(list[i].title,list[i].artist);
  updatePlaylistUI(list);
  setMediaSession(list[i]);
  if(autoplay) play();
}

function updatePlaylistUI(list=playlistData){
  [...playlistEl.children].forEach((d,j)=>{d.classList.toggle("active",j===current);if(j===current)d.scrollIntoView({block:"nearest"});});
}

function play(){audio.play();playBtn.textContent="‚è∏";}
function pause(){audio.pause();playBtn.textContent="‚ñ∂";}
playBtn.onclick=()=>audio.paused?play():pause();
prevBtn.onclick=()=>loadTrack((current-1+playlistData.length)%playlistData.length,true);
nextBtn.onclick=()=>loadTrack((current+1)%playlistData.length,true);
shuffleBtn.onclick=()=>{shuffling=!shuffling;shuffleBtn.style.background=shuffling?"#ff0":"#e0e0e0";};

audio.onended=()=>{ if(shuffling){current=Math.floor(Math.random()*playlistData.length);}else{current=(current+1)%playlistData.length;} loadTrack(current,true);};

function safeKey(...a){return a.join("_").replace(/[^a-z0-9]/gi,"_");}
async function fetchCover(title,artist){
  const key=safeKey("cover",artist+"_"+title);
  const cached=localStorage.getItem(key);
  if(cached){coverEl.style.backgroundImage=`url(${cached})`;return;}
  try{
    let q=encodeURIComponent(artist+" "+title);
    let res=await fetch(`https://itunes.apple.com/search?term=${q}&entity=song&limit=1`);
    let data=await res.json();
    if(data.results&&data.results.length){
      let url=data.results[0].artworkUrl100.replace("100x100bb","512x512bb");
      coverEl.style.backgroundImage=`url(${url})`;
      yearEl.textContent=data.results[0].releaseDate?new Date(data.results[0].releaseDate).getFullYear():"";
      localStorage.setItem(key,url);
    }else coverEl.style.backgroundImage="url('https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png')";
  }catch(e){coverEl.style.backgroundImage="url('https://upload.wikimedia.org/wikipedia/commons/8/84/Music_icon.png')";}
}

function setMediaSession(track){
  if("mediaSession"in navigator){
    navigator.mediaSession.metadata=new MediaMetadata({title:track.title,artist:track.artist,album:"Retro Player",artwork:[{src:coverEl.style.backgroundImage.slice(5,-2),sizes:"512x512",type:"image/png"}]});
    navigator.mediaSession.setActionHandler("play",()=>play());
    navigator.mediaSession.setActionHandler("pause",()=>pause());
    navigator.mediaSession.setActionHandler("previoustrack",()=>prevBtn.click());
    navigator.mediaSession.setActionHandler("nexttrack",()=>nextBtn.click());
  }
}

// Visualizer
const canvas=document.getElementById('visualizer'),ctx=canvas.getContext('2d');
function resizeCanvas(){const dpr=window.devicePixelRatio||1;canvas.width=canvas.clientWidth*dpr;canvas.height=canvas.clientHeight*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);}
window.onresize=resizeCanvas;resizeCanvas();

function initAudio(){
  if(initialized)return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  sourceNode=audioCtx.createMediaElementSource(audio);
  analyser=audioCtx.createAnalyser();analyser.fftSize=1024;analyser.smoothingTimeConstant=0.85;
  sourceNode.connect(analyser);analyser.connect(audioCtx.destination);
  initialized=true;
}

function drawViz(){
  if(!analyser)return;
  let bufferLength=analyser.frequencyBinCount,data=new Uint8Array(bufferLength);
  function loop(){
    rafId=requestAnimationFrame(loop);
    analyser.getByteFrequencyData(data);
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    let bars=Math.min(160,Math.floor(canvas.clientWidth/6)),step=Math.floor(bufferLength/bars),barW=canvas.clientWidth/bars,x=0;
    for(let i=0;i<bufferLength;i+=step){
      let sum=0;for(let j=0;j<step&&i+j<bufferLength;j++)sum+=data[i+j];
      let v=sum/step/255,barH=v*canvas.clientHeight*0.9;
      ctx.fillStyle=`hsl(${200-(i/bufferLength*200)},80%,${30+v*45}%)`;
      ctx.fillRect(x,canvas.clientHeight/2-barH/2,barW-1,barH);
      x+=barW;
    }
  }loop();
}

audio.onplay=async()=>{initAudio();if(audioCtx.state==="suspended")await audioCtx.resume();drawViz();};
audio.onpause=()=>cancelAnimationFrame(rafId);

playlistSelect.onchange=()=>{playBtn.textContent="‚ñ∂";loadPlaylist(playlistSelect.value);};
loadPlaylist(playlistSelect.value);

// Service worker
if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js').catch(console.error);}
</script>
</body>
</html>
